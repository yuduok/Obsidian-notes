## 防火墙概述

防火墙是由软件和硬件组成的系统，它处于安全的网络和不安全的网络之间，属于**边界防护设备**，由系统管理员设置访问控制规则，对进出网络边界的数据流进行过滤。

### 防火墙对数据流的处理方式

- **允许**满足规则的数据流通过——访问控制
- **拒绝**不满足规则的数据流通过，并向发送者回复一条消息提示该数据流被拒绝
- 将数据流**丢弃**，不对这些数据包进行任何处理，也不会发送提示

### 防火墙必须满足的要求

- 所有进出网络数据流必须经过防火墙
- 只允许经授权的数据流通过
- 防火墙自身对入侵免疫，即自身安全

## 防火墙的类型和结构

### 类型

逻辑上看
- 主机防火墙
- 网络防火墙

物理上看
- 硬件防火墙
- 软件防火墙

### 防火墙分类和设计结构

- 包过滤防火墙
- 电路级防火墙
- 应用级防火墙
![[Pasted image 20241226192225.png]]

防火墙通常建立在TCP/IP模型基础上，OSI模型与TCP/IP模型之间并不存在一一对应关系

## 静态包过滤器（分组过滤）

静态包过滤防火墙是最原始的防火墙，静态数据包过滤发生在**网络层**

- 采用过滤模块实现
- 较低的安全性
- 直接使用路由器软件过了
- 无需购买专门设备，减少投资

### 流程

1. 防火墙接收到从外部网络到达防火墙的数据包，对数据包过滤。
2. 对数据包施加过滤规则，对数据包IP头和传输字段内容进行检查。
3. 如果没有规则与数据包头信息匹配，则对数据包施加默认规则

### 过滤规则

规则由一组属性值和操作组成，构成规则的属性值通常由以下字段组成
- 源IP地址
- 目的IP地址
- 源和目的端口号
- 协议类型

#### 过滤规则集

- 黑名单：列出禁止传输的IP分组类型
- 白名单：列出允许传输的IP分组类型

### 工作原理

#### [[#过滤规则]]

#### 过滤位置

可以在网络**入口**，也可以在网络**出口**，或者入口出口同时进行过滤

#### 访问控制策略

网管需预先编写访问控制列表，明确规定哪些主机或服务可接受或不接受

#### 分组过滤器

- **无状态**是指实施筛选和控制操作时，每一个IP分组都是独立的，不考虑IP分组之间的关联性
- **有状态**是指将属于同一连接的所有包作为一个整体的数据流看待，对接收到的数据包进行分析，判断其是否属于当前合法连接，从而进行动态地过滤

## 动态包过滤防火墙

特点
- 具有状态感知能力
- **位于传输层**
- 检查的数据包头信息：源地址、目的地址、源和目的端口、**应用或协议**

### 工作原理

- 对外出数据包进行身份记录，便于下次让具有相同连接的数据包通过
- 需要对已建连接和规则表进行动态维护，因此是动态的和有状态的
- 能够感觉到新建连接与已建连接之间的差别

实现动态包过滤器的两种主要方式
- **实时地改变**普通包过滤器的规则集
- 采用**类似电路级网关**的方式转发数据包（为每个连接建立专门的转发通道）

### linux的iptables防火墙

iptables不是真正的防火墙，可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的“安全框架”中，这个"安全框架"才是真正的防火墙，叫netfilter

netfilter/iptables组成linux平台下的包过滤防火墙，具有以下功能
- NAT
- 数据包内容修改
- 数据包过滤防火墙

####  处理链（Chains）

系统中有五个预定义的链：
- **PREROUTING** - 数据包刚刚到达网络接口
- **INPUT** - 发往本机的数据包
- **FORWARD** - 经过本机转发的数据包
- **OUTPUT** - 本机发出的数据包
- **POSTROUTING** - 数据包离开本机前的最后处理

####  规则表（Tables）

主要的表包括：
- **filter** - 负责过滤功能，防火墙
- **nat** - 网络地址转换
- **mangle** - 数据包修改
- **raw** - 配置免除连接跟踪
- **security** - SELinux 标记

#### 各表的优先级（从高到低）

1. raw
2. mangle
3. nat (PREROUTING)
4. filter
5. security
6. nat (OUTPUT/POSTROUTING)

#### 表链对应关系

每个表可以使用的链如下：

```plaintext
┌───────────┬─────────────┬────────┬─────────┬────────────┬──────────┐
│   表名     │ PREROUTING │ INPUT  │ FORWARD │  OUTPUT    │POSTROUTING│
├───────────┼─────────────┼────────┼─────────┼────────────┼──────────┤
│ raw       │     ✓       │        │         │     ✓      │          │
│ mangle    │     ✓       │   ✓    │    ✓    │     ✓      │    ✓     │
│ nat       │     ✓       │   ✓    │         │     ✓      │    ✓     │
│ filter    │             │   ✓    │    ✓    │     ✓      │          │
│ security  │             │   ✓    │    ✓    │     ✓      │          │
└───────────┴─────────────┴────────┴─────────┴────────────┴──────────┘
```

## 电路级网关

工作于**会话层**

功能：确保已建立的连接是安全的

与包过滤的区别：除了进行基本的包过滤检查外，还要增加对连接建立过程中的**握手信息SYN、ACK及序列号合法性的验证**。

检查内容：源和目的IP地址、源和目的端口、应用或协议、**握手信息及序列号**

电路级网关通常作为应用代理服务器的一部分，在**应用代理类型防火墙**中实现

### 工作流程

1. 客户端发起连接请求到防火墙
2. 防火墙验证请求的合法性
3. 防火墙代表客户端与目标服务器建立新的连接
4. 在两个连接之间转发数据
5. 连接终止时，防火墙关闭两端的连接

## 应用级网关

### 包过滤防火墙与应用级网关的区别

- 包过滤防火墙：过滤所有**不同服务**的数据流。不需要了解数据流的细节，它只查看数据包的源地址和目的地址或检查**UDP/TCP**的端口号和某些标志位
- 应用级网关：只能过滤**特定服务**的数据流。必须为特定的应用服务编写特定的代理程序，被称为“服务代理”，在网关内部分别扮演客户机代理和服务器代理的角色。

**当各种类型的应用服务通过网关时，必须经过客户机代理和服务器代理的过滤。**

### 工作特点

- 必针对每个服务运行一个代理
- 对数据包进行逐个检查和过滤
- 采用“强应用代理”
- 在更高层上过滤信息自动创建必要的包过滤规则
- 当前最安全的防火墙结构之一
- 只能在**应用层**对数据包进行过滤

### WAF

web应用防火墙

#### 功能

主要检测http、https消息

#### 三种检测机制

1. 协议验证：检测各个**字段的值**可以发现不规范的HTTP请求和响应（往往包含攻击信息）
2. 攻击特征：根据**攻击特征库**中的每一个攻击行为逐个检测相关字段，若果该HTTP请求消息的相关字段值包含了某个攻击行为的**特征信息**，则表明为实施攻击行为
3. 应用规范：根据长期统计分析得出的规律来制定应用规范

#### 工作模式

- 透明模式：WAF位于**终端与Web服务器之间**的传输路径上
- 反向代理模式：在路由器R中添加**静态路由项**，静态路由项使得路由器R将以Web服务器的IP地址为目的IP地址的IP分组**转发给WAF**，**由WAF对经过对HTTP请求消息进行检测，web服务器回送的响应可以不经过WAF**

## 状态检测防火墙

状态检测防火墙在所有7层上进行过滤

## 切换代理

### 工作过程

1. 切换代理首先起电路级代理的作用，以验证RFC建议的三步握手。（传输开始在会话层）
2. 再切换到动态包过滤的工作模式下。（传输后续在网络层）

## 空气隙防火墙

空气隙防火墙通过物理隔离的方式实现网络安全，两个网络之间没有任何物理或直接的网络连接

### 工作原理

1. 完全物理隔离
    - 内外网络使用独立的硬件设施
    - 没有任何网络连接，包括有线和无线
    - 数据传输需要通过人工或专门设备完成
2. 数据传输方式
    - 通过可移动存储设备（如U盘）
    - 专用的数据传输设备
    - 严格控制的数据导入/导出流程

## 分布式防火墙

### 工作原理

1. 网络防火墙
   - 内部网与外部网之间、内部网各子网之间
   - 对内部子网之间的安全防护层
2. 主机防火墙
   - 对服务器和桌面机进行防护
   - 内核模式应用，过滤和限制信息流
3. 管理中心
   - 服务器软件
   - 管理、分发总体安全策略，汇总日志

## 防火墙部署

防火墙的具体部署方法要根据实际的应用需求而定，不是一成不变的

### 外部网络

此边界上设置的防火墙将对外部网络用户发起的通信连接按照防火墙的安全过滤规则进过滤和审计，不符合条件的则不允许连接，起到保护内网的目的。

### DMZ网络

Demilitarized Zone 隔离区

这是从内部网络划分的一个区域，其中包括内部网络中用于公众服务的服务器，如Web、email等

### 内部网络

防火墙要保护的对象，包括全部的内部网络设备、内网核心服务器及用户主机

### 类型

基于以上三种典型的网络体系结构，可部署
- 外部防火墙（内外网络）
- 内部防火墙（内部网络之间）
- 主机型防火墙（个人防火墙）

## 下一代防火墙NGFW

从用户、应用和行为的角度出发，重新实现了**流量分类、访问控制、攻击防护和QoS**等所有传统防火墙功能，并基于这些功能，提供**用户策略、应用策略和行为策略**等智能控制手段，有效解决了传统防火墙无法解决的问题

并集合了**智能接入、灵活组网、全面安全、入侵防御、防病毒、云化管理可视化**运维为一体等下一代防火墙部署场景，提供从**网络层到应用层**的攻击防护