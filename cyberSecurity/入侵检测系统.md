## 入侵检测概述

入侵（Instruction）
- 非法取得系统控制权
- 利用系统漏洞收集信息
- 破坏信息系统

入侵检测（Instruction Detection）
- 检测对系统的非授权访问
- 监控系统运行状态，保证系统资源的保密性、完整性、可用性
- 识别针对计算机系统、网络系统或广义信息系统的非法攻击

进行入侵检测的软硬件组合便是入侵检测系统（Instruction Detection System）

### 入侵检测的工作原理

#### 通用框架结构

- 事件产生器：从整个计算环境获得事件，并向系统的其他部分提供。事件是需要IDS分析的**数据**
- 事件分析器：根据事件数据库中的**入侵特征描述、用户历史行为模型**等信息，对事件产生器提供的事件进行分析并产生分析结果
- 响应单元：对分析结果作出反应的功能单元，可以作出**切断连接、改变文件属性**等强烈反应，也可以只是**简单的报警**
- 事件数据库：**存放**各种中间和最终数据的地方，存储用于作为判别事件是否合法的依据的信息，可以是复杂的数据库也可以是简单的文本文件

### IDS的主要功能

- 网络流量的跟踪和分析
- 已知攻击特征的识别
- 异常行为的分析、统计与响应
- 特征库的在线和离线升级
- 数据文件的完整性检查
- 自定义响应
- 系统漏洞的预报警
- IDS探测器集中管理

## 入侵检测原理及主要方法

### 异常检测基本原理

**基于行为的入侵检测技术**，用来识别主机和网络中的异常行为（攻击与正常合法活动有明显差异）。

- 可以发现新型入侵行为，漏报少
- 容易产生误报

### 误用检测基本原理

**基于知识的入侵检测技术**，该技术假设所有入侵行为和手段（及其变形）都能表达为一种模式或特征

- 有针对性地建立高效IDS，精准性高，误报少
- 但只能发现攻击库中已有的攻击，可能发生漏报，且复杂性随着攻击数量的增加而增加

### 其他技术

- 基于概率统计的检测
- 基于神经网络的检测
- 基于专家系统的检测
- 基于模型推理的检测
- 基于免疫的检测
- 新技术（数据挖掘技术、移动代理技术）

## IDS结构与分类

### IDS结构

- 事件提取
- 入侵分析
- 入侵响应
- 远程管理

### IDS分类

按照数据来源分类
- 基于网络的IDS（NIDS）：截获数据包与知识库比较
- 基于主机的IDS（HIDS）：对日志和审计记录的监控分析
- 分布式IDS（DIDS）：同时分析主机系统审计日志和网络数据流

按照检测策略分类
- 误用检测：将收集的信息与数据库作比较
- 异常检测：测量数学的平均值，并用来与系统行为比较
- 完整性分析：关注是否被更改

### NIDS

#### 常用技术

- **攻击模式**、表达式或字节匹配
- 频率或穿越阈值
- 低级事件的**相关性**
- 统计学意义上的非常规现象检测

#### 优点

- 提供实时网络行为检测
- 同时保护网络主机
- 良好的隐蔽性
- 有效保护入侵证据
- 不影响被保护主机的性能
- 操作系统无关性

#### 缺点

- 防入侵欺骗能力差
- 交换式网络环境中难以配置
- 检测性能受硬件条件限制
- 不能处理加密后的数据

#### 具体部署位置

1. 外网接入点部署
```
Internet
    ↓
[防火墙]
    ↓
[NIDS] ← 部署位置1
    ↓
内部网络
```

2. DMZ区部署
```
Internet
    ↓
[防火墙]
    ↓
[NIDS] ← 部署位置2
    ↓
[DMZ服务器]
    ↓
[防火墙]
    ↓
内部网络
```

3. 内网核心交换区部署
```
内部网络
    ↓
[核心交换机]
    ↓
[NIDS] ← 部署位置3
    ↓
[关键服务器群]
```

4. 关键子网
```
         → [NIDS1] → 财务区
[核心] → → [NIDS2] → 研发区
         → [NIDS3] → 办公区
```

#### NIDS关键技术

##### 1. IP碎片重组技术

**基本原理：**
- 重建被分片的IP数据包
- 按照偏移量排序碎片
- 检查碎片重叠
- 验证碎片完整性

**关键实现：**
```
1. 碎片识别
   - IP头部标识字段匹配
   - 碎片偏移检查
   - 更多碎片(MF)标志检查

2. 碎片存储
   - 哈希表存储
   - 超时机制
   - 内存管理

3. 异常处理
   - 重叠碎片检测
   - 超时碎片清理
   - 畸形碎片处理
```

##### 2. TCP流重组技术

**基本原理：**
- 按序号重组TCP分段
- 维护TCP会话状态
- 处理乱序和重传
- 重建应用层数据流

**实现机制：**
```
1. 会话跟踪
   - 五元组标识
   - 序列号跟踪
   - 状态维护

2. 数据重组
   - 序号排序
   - 缓冲区管理
   - 重传处理

3. 资源管理
   - 会话超时
   - 内存限制
   - 缓冲区优化
```

##### 3. TCP状态检测技术

**状态跟踪：**
- 三次握手状态
- 数据传输状态
- 四次挥手状态
- 异常状态检测

**检测重点：**
```
1. 连接建立
   SYN → SYN/ACK → ACK

2. 数据传输
   - 序列号合法性
   - 确认号有效性
   - 标志位组合合法性

3. 连接终止
   FIN → ACK → FIN → ACK
```

##### 4. 协议分析技术

**分析层次：**
1. **网络层分析**
   - IP协议解析
   - ICMP协议检测
   - 路由协议分析

2. **传输层分析**
   - TCP/UDP协议解析
   - 端口识别
   - 会话跟踪

3. **应用层分析**
   - HTTP协议分析
   - DNS协议检测
   - SMTP/FTP等协议识别

**实现方法：**
```
- 协议解析器
- 状态机管理
- 深度包检测
- 协议异常检测
```

##### 5. 零复制技术

**工作原理：**
- 避免数据多次复制
- 直接内存访问
- 减少CPU开销
- 提高处理效率

**实现方式：**
```
1. 内核层实现
   - mmap内存映射
   - 网卡DMA直接访问
   - 共享内存机制

2. 应用层优化
   - 缓冲区管理
   - 内存对齐
   - 批量处理
```

##### 6. 蜜罐技术

**基本功能：**
- 诱骗攻击者
- 收集攻击信息
- 延缓攻击进程
- 研究攻击手法

**部署策略：**
```
1. 低交互蜜罐
   - 模拟基本服务
   - 资源消耗少
   - 维护简单

2. 高交互蜜罐
   - 真实操作系统
   - 完整服务模拟
   - 详细攻击记录

3. 混合部署
   - 多层次防护
   - 协同检测
   - 信息共享
```


### HIDS

#### 常用技术

- 文件和注册表保护技术
- IIS保护技术
- 网络安全防护技术
- 文件完整性分析技术

#### 具体部署位置

- 系统内核层
- 重要目录和文件
- 关键应用程序
- 网络接口层
- 系统关键服务

#### 工作过程

- 安装于被保护主机中
- 主要分析主机内部活动（系统日志、应用程序日志、文件完整性检查）

#### 检测内容

**系统调用、端口调用、系统日志、安全审计、应用日志**

#### 优点

- 检测准确度高
- 可以检测没有明显行为特征的入侵
- 能对不同操作系统进行有针对性的检测
- 成本低
- 不会因网络流量影响性能
- 适合加密和交换环境

#### 缺点

- 实时性差
- 无法检测数据包的全部
- 检测效果取决于日志系统
- 占用主机资源
- 隐蔽性差
- 如果入侵者能够修改校验和，HIDS无法起到预期作用

### DIDS

DIDS基于NIDS和HIDS的缺点应运而生

#### 结构

![[Pasted image 20241230001410.png]]

## IDS设计上的考虑与部署

### 网络入侵检测系统工作过程

- 捕获信息
- 检测异常信息
- 反制异常信息
- 报警
- 登记

### 控制台的设计重点

- 日志检索（包括来源和目标目标地址、来源和目标端口、攻击特征、风险等级、时间段）
- 探测器管理
- 规则管理
- 日志报表管理
- 用户管理

### 自身安全设计

- 系统安全：IDS部署在**网络关键节点**上，通常放置在**防火墙的DMZ**中，当攻击成功通过防火墙后，系统会识别并**告警**，并与**防火墙联动**来阻断攻击
- 认证和审计：防止非法用户使用，控制台管理程序登陆需要进行高强度的身份认证，并且对用户的登录事件和具体操作过程进行详细审计
- 通信安全：控制台和检测器之间采用TCP/IP通信，为了保护二者间的通信可采用SSL对传输数据加密

### IDS的两种应用方式

- 在线方式：IDS位于关键链路中间，经过该关键链路传输的信息必须经过IDS
- 杂凑方式：IDS不会影响信息流的传输过程，被动地获取和检测信息

### 基于网络IDS的部署

[[#具体部署位置]]

### 防火墙与入侵检测的区别

![[Pasted image 20241230002747.png]]