## 路由器和互联网结构

### 互联网结构

多个不同类型的网络通过路由器连接在一起，路由器采用数据报交换方式，通过路由项指出通往每一个网络的传输路径，**路由表是路由项的集合**。

两个主机间的传输路径分为两个层次
- 连接在同一传输网络上的两个结点之间的
- IP传输路径（源和目的主机、路由器、传输网络组成的）

### 路由器作用

1. 实现**不同类型传输网络的互联**
2. 建立用于指明通往互联网中每一个网络的传输路径的**路由项**
3. 实现I**P分组转发**

### 针对路由器的攻击

- 路由项欺骗攻击
- 拒绝服务攻击

详见[[局域网网络攻击与防御技术]]

### 互联网安全技术功能

- 安全路由
- 流量管制
- NAT：外部终端无法对内部网络发起攻击
- VRRP（虚拟路由冗余协议）：为终端提供多个默认网关，其中一个瘫痪也不会影响终端之间的通信过程

## 安全路由

### 防路由项欺骗攻击

[[局域网网络攻击与防御技术]]

### 路由项过滤

屏蔽掉和过滤器中目的网络匹配的路由项，保证内部网络对外部路由器的透明性

### 单播反向路径验证

路由器通过单播反向路径验证完成**防源IP地址欺骗**

### 策略路由

允许为符合特定条件的IP分组选择特殊的传输路径

## 流量管制
### DoS攻击

[[局域网网络攻击与防御技术]]

### 信息流分类

从IP分组流中分离出属于特定应用的一组IP分组

TCP连接过程：
- IP首部协议字段值：6（TCP）
- TCP首部控制标志位：SYN=1，ACK=0

ICMP ECHO请求报文：
- IP首部协议字段值：1（ICMP）
- ICMP类型字段值：8（ECHO请求）

### 管制算法

#### 漏斗管制

- 保证信息流**恒速**输出
- 溢出会丢弃后续分组

#### 令牌桶

限制进入网络的平均速率

令牌生成器恒速生成令牌（**R/s**），一旦令牌桶溢出，丢弃后续令牌。，每一个令牌对应**K**字节，令牌桶容量为**D**令牌

## NAT

技术产生原因：IPv4地址耗尽

技术实现了私网与公网的互访，有效隐藏内部局域网的主机ip地址，**为私网提供安全保障，但也为公网带来安全隐患**

#### 内部网络到外部网络的IP分组

源IP地址：内部**本地**地址->内部**全球**地址
目的IP地址：外部**本地**地址->外部**全球**地址

#### 外部网络到内部网络的IP分组

源IP地址：外部**全球**地址->外部**本地**地址
目的IP地址：内部**全球**地址->内部**本地**地址

### NAT类型
#### 静态NAT

内外地址**一对一**转换（映射）

#### 动态NAT

构成一个IP**地址池**，当有主机需要访问外网时，就分配一个合法IP地址与内部地址进行转换，用完归还

#### PAT（端口NAT）

使用端口多路复用技术，将多个内部地址映射为一个合法地址，用**不同端口号**区分各个内部地址

路由器支持的PAT**会话数有限**，所以PAT的局域网网络规模不该太大

#### 复用NAT池（复用动态NAT）

NAT和PAT的结合，可用于大规模局域网

用端口区分的不是一台主机而是一个**网络连接（会话）**，一台主机同时建立多个会话时，每个会话都会占用一个端口映射

## VRRP

通过把**几台路由设备联合组成一台虚拟的路由设备**，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信

### 基本概念

**Master路由器**：承担转发报文的VRRP设备
**Backup路由器**：不承担报文转发，当Master故障时，将竞选称为新的Master
**VRID**：虚拟路由器的标识
**虚拟IP地址**：虚拟路由器的IP地址，一个虚拟路由器可以有一个或多个IP地址
**IP地址拥有者**：一个VRRP设备将虚拟路由IP地址作为真实的接口地址，则称该设备为IP地址拥有者，通常为Master
**虚拟MAC地址**：虚拟路由器根据虚拟路由器ID生成的MAC地址

#### 模式

- 抢占模式：抢占模式下，Backup设备如果优先级高于Master，则主动切换为Master
- 非抢占模式：只要Master没有故障，Backup设备不会成为Master

### 状态机

VRRP协议定义了三个状态机
- 初始状态（Initialize）
- 活动状态（Master）
- 备份状态（Backup）

#### 初始状态

VRRP不可用，一般刚配置或故障会是这个状态

收到接口Up的消息后，如果设备优先级为255则成为Master，小于为Backup

#### 活动状态

- 定期发送VRRP报文
- 以虚拟MAC地址响应ARP请求
- 如果收到比自己优先级大的则转为Backup
- 优先级相同并且IP地址比自己大，转为Backup
- 收到Shutdown事件转为初始状态Initialize
- 如果是虚拟IP地址拥有者，接收目的IP为该IP的IP报文否则丢弃

#### 备份状态

- 接收Master的VRRP报文判断Master状态是否正常
- 收到优先级比自己小的报文，切换为Master（抢占模式）
- 优先级相同或比自己高，重置定时器，不比较IP地址大小
- 收到Shutdown事件转为Initialize
- 丢弃目的IP地址为虚拟IP地址的报文（因为Master接收）

### VRRP两种模式

#### 主备备份模式

- 只由Master负责转发数据
- Backup处于待机备份不参与数据转发
- Master故障才会切换新的Master进行数据转发

#### 负载均衡模式

创建两个VRRP组，不同组的Master不同，为不同的VLAN指定网关（不同的VRRP组）以实现负载均衡

