### 安全协议总览

- TLS/SSL（传输层安全/安全套接字层）
- IPSEC（Internet协议安全）
- PPTP（点对点隧道协议）
- ......

---
### TLS协议分析

TLS记录协议位于传输层与应用层之间

TLS握手协议、TLS密钥交换协议和TLS报警协议均与HTTP和FTP一样属于应用层协议

#### TLS记录协议

1. 基本功能
- 负责数据的**加密、压缩和完整性保护**
- 将上层协议（如 HTTP）的数据进行封装和保护
- 确保数据在传输过程中的机密性和完整性

2. **记录协议工作流程**
- **数据分片**：将上层协议的数据分割成多个记录
- **数据压缩**（可选）
- **数据加密**
- 添加消息认证码（**MAC**）以保证完整性

3. 加密过程
- 使用协商好的对称加密算法（如 AES）
- 使用会话密钥进行加密
- 生成消息认证码（MAC）

#### TLS密钥交换协议

TLS 密钥交换协议用于在客户端和服务器之间安全地协商和建立共享的会话密钥，更新用于当前连接的密码组

#### TLS告警协议

TLS 告警协议（Alert Protocol）用于传递错误和状态信息

告警类型分为两大类：
- 致命告警（**Fatal** Alerts）：导致连接立即终止
- 警告告警（**Warning** Alerts）：不一定终止连接，通常只是记录日志

#### TLS握手协议

使得服务器和客户端能够相互鉴别对方，协商具体的**加密算法**和**MAC算法**以及**保密密钥**。

1. 握手协议的主要目标
- 协商 TLS **版本**
- 选择**加密算法**（密码套件）
- **验证**服务器身份（可选验证客户端）
- **建立会话密钥**

2. 基本握手流程（TLS 1.2）

```plaintext
客户端                                               服务器
ClientHello            -------->
                                          ServerHello
                                         Certificate*
                                   ServerKeyExchange*
                                  CertificateRequest*
                      <--------      ServerHelloDone
Certificate*
ClientKeyExchange
CertificateVerify*
ChangeCipherSpec
Finished              -------->
                                   ChangeCipherSpec
                      <--------           Finished
应用数据              <------->         应用数据
```

3. **详细握手步骤**

A. 第一阶段：建立连接
- ClientHello：
  - 支持的 TLS 版本
  - 客户端随机数
  - 支持的密码套件
  - 压缩方法

- ServerHello：
  - 选择的 TLS 版本
  - 服务器随机数
  - 选择的密码套件
  - 选择的压缩方法

B. 第二阶段：服务器认证
- 服务器发送证书链
- 可选的 ServerKeyExchange
- 可选的客户端证书请求
- ServerHelloDone 标志

C. 第三阶段：密钥交换
- 客户端验证服务器证书
- 发送 ClientKeyExchange
- 生成预主密钥（Pre-Master Secret）

D. 第四阶段：完成握手
- 双方计算主密钥和会话密钥
- 发送 ChangeCipherSpec
- 发送 Finished 消息

4. TLS 1.3 改进
- 减少握手往返次数（1-RTT）
- 支持 0-RTT 恢复会话
- 移除了不安全的加密算法
- 简化了密码套件

---
### IPSEC协议分析

#### 工作原理

IPSec的工作原理类似于包过滤防火墙，可以把它看做是包过滤防火墙的一种扩展

a) 流量触发

- 当有IP数据包需要发送时，系统会检查是否需要应用IPSec策略。
- 这通常基于预配置的IPSec策略，如特定的源/目标IP地址或端口。

b) 策略查找

- 系统查询安全策略数据库（**SPD**）。
- SPD定义了哪些流量应该被保护，以及如何保护。（对接收到的IP数据包进行转发、丢弃或IPSec处理）

c) 安全关联（SA）协商

- 如果需要IPSec保护且没有现存的SA，则启动IKE（Internet Key Exchange）过程。
- IKE协商分为两个阶段：
    - 第一阶段：建立安全的通信通道（ISAKMP SA）
    - 第二阶段：协商特定的IPSec SA

IKE第一阶段（主模式）：

1. 提议和接受加密/认证算法
2. Diffie-Hellman密钥交换
3. 身份验证（预共享密钥或证书）

IKE第二阶段（快速模式）：

1. 协商IPSec SA参数
2. 生成密钥材料
3. 建立IPSec SA

d) 数据处理

- 基于协商的SA，对数据进行处理：
    - 使用AH：计算并添加认证头
    - 使用ESP：加密数据并添加ESP头尾

处理步骤（以ESP为例）：

1. 生成IV（初始化向量）
2. 加密IP数据包载荷
3. 计算并添加完整性校验值（ICV）
4. 封装ESP头和尾

e) 传输

- 处理后的数据包通过网络发送到目的地

#### IPSec工作模式

IPsec使用认证头标（**AH**）和封装安全净载（**ESP**）两种安全协议来提供安全通信

a) 传输模式（用在主机到主机的通信）
- 仅加密/认证IP数据包的载荷
- 原始IP头保持不变

b) 隧道模式（用在其他任何方式的通信）
- 加密整个原始IP数据包
- 添加新的IP头

#### 主要协议

1. AH（认证头）协议

特点：
- 提供数据完整性和源认证
- 不提供数据加密
- 使用HMAC算法进行数据认证

**数据包结构**：
- 下一头
- 载荷长度
- 保留字段
- 安全参数索引（SPI）
- 序列号
- 认证数据

2. ESP（封装安全载荷）协议

也有两种工作模式：
- **传输模式**
- **隧道模式**

功能：
- 提供数据加密
- 提供数据完整性
- 提供源认证

**数据包结构**：
- SPI（安全参数索引）
- 序列号
- 加密载荷
- 完整性校验值（ICV）

3. IKE（密钥交换）协议

主要阶段：
- 第一阶段：建立安全信道
- 第二阶段：协商安全关联（SA）

密钥交换特点：
- 使用 Diffie-Hellman 密钥交换
- 支持**证书**和**预共享密钥**认证
- 周期性重新协商密钥

4. 安全关联（SA）

定义：
- **单向**逻辑连接（所以在进行双向安全通信时，需要两个SA，SA（out）、SA（in））
- 定义安全参数
- 包含加密算法、密钥等信息

SA 管理：
- 手动配置
- 自动协商（IKE）

